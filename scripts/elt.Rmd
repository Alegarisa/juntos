---
title: "elt"
author: "Alejandra Garcia Isaza"
date: "2/2/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(rio)
library(here)
library(tidyverse)
library(haven)

library(surveytoolbox)
library(sjPlot)
```


```{r}

w1_raw <- haven::read_sav(here("nopublish", "ELT W1 ERC 11.11.2020.sav"))

w1_raw
```

```{r}

elt_w1_clean <- w1_raw %>% 
  janitor::clean_names() %>%
  select(-1:-9, -13:-17, -202) %>% # deleting columns with metadata
  arrange(pj) # ordering participants ids

elt_w1_clean
```

```{r}

# fixing duplicates ids
duplicated(elt_w1_clean$pj) # pj_number: 257 is dupplicated and there is no 254

elt_w1_clean <- elt_w1_clean %>%
  mutate(pj = case_when(recipient_first_name == "Beth" ~ "254",
                        TRUE ~ as.character(pj))) %>%
  arrange(pj)

duplicated(elt_w1_clean$pj) # testing that there are no more id duplicates == No duplicates!

elt_w1_clean
```

```{r}

# fixing wrong assignment
elt_w1_clean_2 <- elt_w1_clean %>%
  mutate(school_id = str_sub(pj, 1, 1),
         condition = case_when(
           school_id == "1" | school_id == "3" | school_id == "5" ~ "1",
           school_id == "2" | school_id == "4" | school_id == "6" ~ "2"
         )) %>%
  select(school_id, condition, everything()) %>%
  add_column(wave = 1, .before = 10) %>%
  select(- school)

elt_w1_clean_2
```

```{r}

# making variables numeric and adding labels  
elt_w1_clean_3 <- elt_w1_clean_2 %>%
  mutate(condition = as.numeric(condition),
         condition = set_vall(condition, c("control" = 1, "intervention" = 2)),
         school_id = as.numeric(school_id),
         school_id = set_vall(school_id, c("cascade" = 1, "prairie_mountain" = 2, "kelly" = 3, "ata" = 4, "briggs" = 5, "agnes_stewart" = 6))) # this worked!!!

elt_w1_clean_3

view_df(elt_w1_clean_3) # nice plot that serves as codebook
```

```{r}

# exporting to .sav to check proper coding of condition and labels
# elt_w1_clean_3 %>%
#   haven::write_sav(here("nopublish", "elt_w1_clean_3.sav"))
```

Results:
- This would be the master dataset
- school_id matchs assigned condition properly!
- Labels were properly exported (both variable labels and level labels on .sav file)

```{r}

# collapsing variable english_comfort q132_1_<<choice>>

d <- elt_w1_clean_3 %>% 
    select(pj, starts_with("q132_1")) %>% 
    pivot_longer(
      cols = starts_with("q132_1"),
      names_to = "item",
      values_to = "english_comfort",
      values_drop_na = TRUE) %>% 
   filter(english_comfort == 1) %>%
  mutate(english_comfort = case_when(item == "q132_1_4" ~ "4",
                                     item == "q132_1_3" ~ "3",
                        TRUE ~ as.character(english_comfort))) %>%
  select(-item)

x <- left_join(elt_w1_clean_3, d)

x_2 <- x %>%
  mutate(english_comfort = as.numeric(english_comfort),
         english_comfort = set_vall(english_comfort, c("not at all comfortable" = 1, "somewhat comfortable" = 2, "comfortable" = 3, "very comfortable" = 4, "no response" = 99)))


view_df(x_2)

# x_2 %>%
#   haven::write_sav(here("nopublish", "x_2.sav")) # it worked, the .sav file has all 43 participants with the proper scale and the proper level labels. 
```


```{r}
# collapsing language variables q132_<<language>>_<<choice>> 

# collapsing english variables
eng <- elt_w1_clean_3 %>% 
  select(pj, starts_with("q132_1")) %>% 
    pivot_longer(
      cols = starts_with("q132_1"),
      names_to = "item_1",
      values_to = "english_comfort",
      values_drop_na = TRUE) %>% 
   filter(english_comfort == 1) %>%
  mutate(english_comfort = case_when(item_1 == "q132_1_1" ~ "1",
                                     item_1 == "q132_1_2" ~ "2",
                                     item_1 == "q132_1_3" ~ "3",
                                     item_1 == "q132_1_4" ~ "4",
                                     item_1 == "q132_1_99" ~ "99",
                        TRUE ~ as.character(english_comfort)))  %>%
  select(-item_1)

duplicated(eng$pj) # no duplicates

# collapsing spanish variables
spa <- elt_w1_clean_3 %>%
  select(pj, starts_with("q132_2")) %>% 
    pivot_longer(
      cols = starts_with("q132_2"),
      names_to = "item_2",
      values_to = "spanish_comfort",
      values_drop_na = TRUE) %>% 
   filter(spanish_comfort == 1) %>%
  mutate(spanish_comfort = case_when(item_2 == "q132_2_1" ~ "1",
                                     item_2 == "q132_2_2" ~ "2",
                                     item_2 == "q132_2_3" ~ "3",
                                     item_2 == "q132_2_4" ~ "4",
                                     item_2 == "q132_2_99" ~ "99",
                        TRUE ~ as.character(spanish_comfort))) %>%
  select(-item_2) 

duplicated(spa$pj) # pj 454 is duplicated. In w1_raw it shows that this participant chose options 1 and 2 (not sure if they could choose more than one option in Qulatrics). 

# fising duplicate
spa_2 <- spa %>% 
  distinct(pj, .keep_all = TRUE) # Option 1, "not at all comfortable" was chosen because the duplicate was the second option.  

duplicated(spa_2$pj) # no duplicates

# joining english and spanish variables
langs <- left_join(eng, spa_2) 

# collapsing other language 1 variables
other_1 <- elt_w1_clean_3 %>% 
  select(pj, starts_with("q132_3"), -q132_3_text) %>% 
    pivot_longer(
      cols = starts_with("q132_3"),
      names_to = "item_3",
      values_to = "other1_lang_comfort",
      values_drop_na = TRUE) %>% 
   filter(other1_lang_comfort == 1) %>%
  mutate(other1_lang_comfort = case_when(item_3 == "q132_3_1" ~ "1",
                                    item_3 == "q132_3_2" ~ "2",
                                    item_3 == "q132_3_3" ~ "3",
                                    item_3 == "q132_3_4" ~ "4",
                                    item_3 == "q132_3_99" ~ "99",
                        TRUE ~ as.character(other1_lang_comfort)))  %>%
  select(-item_3)


duplicated(other_1$pj) # no duplicates

# collapsing other language 2 variables
other_2 <- elt_w1_clean_3 %>% 
  select(pj, starts_with("q132_4"), -q132_4_text) %>% 
    pivot_longer(
      cols = starts_with("q132_4"),
      names_to = "item_4",
      values_to = "other2_lang_comfort",
      values_drop_na = TRUE) %>% 
   filter(other2_lang_comfort == 1) %>%
  mutate(other2_lang_comfort = case_when(item_4 == "q132_4_1" ~ "1",
                                    item_4 == "q132_4_2" ~ "2",
                                    item_4 == "q132_4_3" ~ "3",
                                    item_4 == "q132_4_4" ~ "4",
                                    item_4 == "q132_4_99" ~ "99",
                        TRUE ~ as.character(other2_lang_comfort)))  %>%
  select(-item_4)


duplicated(other_2$pj) # no duplicates

# joining other 1 and 2 language variables
others <- left_join(other_1, other_2) 


# joining dataframes with all language variables
lang_vars <- left_join(langs, others)

duplicated(lang_vars$pj) # no duplicates

# renaming variables with text input in master dataset (n = 43)
lang_inputs <- elt_w1_clean_3 %>%
  select(pj, q132_3_text, q132_4_text) %>%
  rename(c("other1_lang" = "q132_3_text"), c("other2_lang" = "q132_4_text"))

duplicated(lang_inputs$pj) # no duplicates

# joining renamed master dataset with all language variables now collapsed to "recover" pj 153 data
all_lang_vars <- left_join(lang_inputs, lang_vars)

duplicated(all_lang_vars$pj) # no duplicates

# recordering all language vars
all_lang_vars <- all_lang_vars %>%
  select(pj, english_comfort, spanish_comfort, other1_lang, other1_lang_comfort, other2_lang, everything())

# creating new dataset that joins master dataset with reordered and collapsed lang vars
elt_w1_clean_4 <- left_join(elt_w1_clean_3, all_lang_vars) %>%
  select(-starts_with("q132_")) # deleting all previous language variables that were included in new variables # 

duplicated(elt_w1_clean_4$pj) # no duplicates, n = 43

# adding value labels on language vars
elt_w1_clean_4 <- elt_w1_clean_4 %>%
  mutate(english_comfort = as.numeric(english_comfort),
         english_comfort = set_vall(english_comfort, c("not at all comfortable" = 1, "somewhat comfortable" = 2, "comfortable" = 3, "very comfortable" = 4, "no response" = 99)),
         spanish_comfort = as.numeric(spanish_comfort),
         spanish_comfort = set_vall(spanish_comfort, c("not at all comfortable" = 1, "somewhat comfortable" = 2, "comfortable" = 3, "very comfortable" = 4, "no response" = 99)),
         other1_lang_comfort = as.numeric(other1_lang_comfort),
         other1_lang_comfort = set_vall(other1_lang_comfort, c("not at all comfortable" = 1, "somewhat comfortable" = 2, "comfortable" = 3, "very comfortable" = 4, "no response" = 99)),
         other2_lang_comfort = as.numeric(other2_lang_comfort),
         other2_lang_comfort = set_vall(other2_lang_comfort, c("not at all comfortable" = 1, "somewhat comfortable" = 2, "comfortable" = 3, "very comfortable" = 4, "no response" = 99)),
         )

view_df(elt_w1_clean_4)

```

```{r}

# renaming demo vars
elt_w1_clean_5 <- elt_w1_clean_4 %>%
  rename(c("age" = "q127_1_text"), 
         c("birth_country" = "q128"),
         c("another_birth_country_text" = "q128_2_text"),
         c("age_first_moved_us" = "q129_1_text"),
         c("white" = "q130_1"),
         c("hispanic_latino_spanish" = "q130_2"),
         c("black_african_american" = "q130_3"),
         c("asian" = "q130_4"),
         c("american_indian_alaska_native" = "q130_5"),
         c("indigenous_americas" = "q130_6"),
         c("middle_eastern_north_african" = "q130_7"),
         c("native_hawaiian_pacific_islander" = "q130_8"),
         c("race_ethnicity_other" = "q130_9"),
         c("race_ethnicity_no_response" = "q130_99"),
         c("indigenous_americas_text" = "q130_6_text"),
         c("race_ethnicity_other_text" = "q130_9_text"),
         c("gender_id" = "q131"),
         c("years_in_position" = "q133"),
         c("years_in_school" = "q134"),
         c("equity_leadership" = "q135_1"),
         c("cultural_responsiveness" = "q135_2"),
         c("restorative_practices" = "q135_3"),
         c("diversity" = "q135_4"),
         c("ell" = "q135_5"),
         c("cont_ed_other" = "q135_6"),
         c("cont_ed_na" = "q135_88"),
         c("cont_ed_no_response" = "q135_99"),
         c("cont_ed_other_text" = "q135_6_text")) %>%
  select(-q127, -q129, -q131_3_text) # deleted: q127, q129, q131_3_text because they did not have meaningful info

view_df(elt_w1_clean_5)

elt_w1_clean_5 %>%
  haven::write_sav(here("nopublish", "elt_w1_clean_5.sav")) # it worked, variable and value labels were succesfully exported.  

```


# to do next
- start descriptive stats analyses
- create timeline to add in week 6 report

# Notes on w1 dataset

- Participant 257 was duplicated and 254 was missing. This was fixed.
- participant 153 didn't complete survey, after q50 it's empty. 
- Total participants in wave 1 n = 43

# Notes on Missing values

- For analysis: filter out when levels have 88, 99, and -99 values?

88 = "not applicable"
99 = "no response"
-99 = seen but unanswered questions -- (e.g questions that ask participants to respond if they have knowledge about classroom)
NA = unseen question, either because participant didn't complete survey (e.g. pj 153) or because of skip logic (they were not teachers or had classroom knowledge)
  --> NA appear in SPSS as a dot (.)
blank spaces =  not sure, but maybe irrelevant

* consider creating a function to recode these options so they are labelled with set_vall() that applies to all variables. 