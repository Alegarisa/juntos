---
title: "parent_3_waves"
author: "Alejandra Garcia Isaza"
date: "6/30/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(rio)
library(here)
library(tidyverse)
library(haven)
library(janitor)
library(knitr)
library(surveytoolbox)
library(sjPlot)
library(kableExtra)
library(psych)

```

################## WAVE 1 ##################

# Loading the data
```{r}
p_w1_raw <- read_sav(here("nopublish", "7b. Juntos Parent W1-SPAN_February 10, 2021_10.24.sav"))

p_w1_raw <- p_w1_raw %>% 
  arrange(ID_1_TEXT) %>% # ordering participants ids
  janitor::clean_names() %>% # cleaning names
  select(-id) %>% 
  rename(c("id" = "id_1_text"))
```

# Checking duplicated ids
```{r}
data.frame(table(p_w1_raw$id)) # 29 ids are duplicated (ids 415 and 418 has 3 instances each)

dupes <- p_w1_raw %>%
  select(id, response_id) %>%
  arrange(id)
```

# initial cleaning
```{r}
p_w1_clean <- p_w1_raw %>% 
  select(-1:-8, -10:-17, -19, -20) %>% # selecting out columns with metadata
  filter(id != "999") %>% # deleting 2 test rows
  filter(response_id != "R_31L6rXjsdcuBaz0") %>% # deleting 1 duped row "false start" (id 312)
  mutate(id = case_when(response_id == "R_12ch5JnOHKHRgre" ~ "408", # id 418 (top) recoded as 408
                        response_id == "R_uaijWwHdl8sIOmB" ~ "317", # had a pj before id #
                        TRUE ~ as.character(id))) %>%
  arrange(id)

data.frame(table(p_w1_clean$id)) # duplicated ids match two-parent families, id 415 is a family of 3
```

# Fixing wrong condition assignment and school id
```{r}
# fixing wrong assignment
p_w1_clean_2 <- p_w1_clean %>%
  mutate(school_id = str_sub(id, 1, 1),
         condition = case_when(
           school_id == "1" | school_id == "3" | school_id == "5" ~ "1",
           school_id == "2" | school_id == "4" | school_id == "6" ~ "2"
         )) %>%
  select(school_id, condition, everything()) %>%
  select(- school) # selecting out (i.e. deleting) original faulty school variable

```

# Adding value labels and making vars numeric 
```{r}
p_w1_clean_3 <- p_w1_clean_2 %>%
  mutate(condition = as.numeric(condition),
         condition = set_vall(condition, c("control" = 1, "intervention" = 2)),
         school_id = as.numeric(school_id),
         school_id = set_vall(school_id, c("cascade" = 1, "prairie_mountain" = 2, "kelly" = 3, "ata" = 4, "briggs" = 5, "agnes_stewart" = 6)))
```

```{r}
p_w1_clean_3 <- p_w1_clean_3 %>% 
  mutate(participant = ifelse(response_id == "R_1ON5POXTzIXrIeb", 4, participant), # changing partic. type to correspond to records
         participant_4_text = ifelse(response_id == "R_1ON5POXTzIXrIeb", "stepmom", participant_4_text), 
         participant = as.numeric(participant),
         participant = set_vall(participant, c("mom" = 1, "dad" = 2, "tutor legal" = 3, "other, specify" = 4)),
         participant_id = paste0(id, "_", participant), .before = 5) %>%
  rename(c("family_id" = "id")) # 125 participants, 92 moms, 32 dads, 1 grandparent. 28 families
```

# renaming vars to correspond to value labels
```{r}
p_w1_clean_3 <- p_w1_clean_3 %>%
  rename(c("q211_1" = "q211_2"),
         c("q211_2" = "q211_99"),
         c("q211_3" = "q211_4"),
         c("q211_4" = "q211_5"),
         c("q211_5" = "q211_6"),
         c("q211_99" = "q211_7"),
         c("adults_home_text" = "q211_6_text"))

num_adults <- p_w1_clean_3 %>% 
  select(participant_id, starts_with("q211_"), -adults_home_text) %>%
  pivot_longer(
    cols = starts_with("q211"),
    names_to = c("item", "adults_home"),
    names_sep = "_",
    values_to = "response",
    values_drop_na = TRUE) %>% 
  filter(response == 1) %>%
  mutate(response = as.numeric(response))

get_dupes(num_adults, participant_id)

# id 114_1 chose options 2 and 4
# id 214_1 chose options 2 and 5
# Option 2, "2" will be chosen because the {distinct} function keeps the first row. Also it can be argued that there are 2 adults in each household and not 4 and 5, respectively. 

num_adults <- num_adults %>% 
  distinct(participant_id, .keep_all = TRUE) %>% 
  select(-item, -response) 

p_w1_clean_4 <- left_join(p_w1_clean_3, num_adults) %>%
  select(-291:-296)
```

#note: check other variables that may need collapsing and evaluate if all tghis work was worth it. Maybe just need to rename the vars and no more = no collapsing. 

# If it makes sense, put adults_home and adults_home_text at the end. Check why output ommitted. 


```{r}
view_df(p_w1_clean_4) 
```

